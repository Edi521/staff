<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff ¬∑ Esc√°ner</title>

  <link rel="icon" href="/staff/icons/icon.png" type="image/png">
  <link rel="manifest" href="manifest.webmanifest?v=1" /> 
  <meta name="theme-color" content="#111827" />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#0b1220; color:#e5e7eb; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }

    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom: 12px; }
    h1{ font-size:20px; margin:0; }
    .muted{ color:#9ca3af; font-size:14px; }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      cursor:pointer;
      font-weight: 700;
    }
    .btn.primary{ background:#2563eb; border-color:#1d4ed8; color:#fff; }
    .btn.danger{ background:#2a0a0a; border-color:#7f1d1d; color:#fff; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }

    .card{ background:#111827; border:1px solid #1f2937; border-radius: 14px; padding: 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    input{
      flex:1; min-width: 240px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      outline:none;
      font-size: 16px;
    }

    .error{ display:none; background:#2a0a0a; border:1px solid #7f1d1d; border-radius:12px; padding:12px; white-space:pre-wrap; }
    .ok{ display:none; background:#052e1a; border:1px solid #14532d; border-radius:12px; padding:12px; white-space:pre-wrap; }

    /* C√°mara */
    .camWrap{ display:grid; gap:10px; }
    video{
      width: 100%;
      border-radius: 14px;
      background:#000;
      border: 1px solid #1f2937;
      max-height: 52vh;
      object-fit: cover;
    }

    /* Ticket preview (resultado) */
    .ticket{
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      border-radius: 16px;
      border:1px solid #1f2937;
      background:#0f172a;
      padding: 16px;
      box-sizing: border-box;
    }

    .ticketGrid{
      display:flex;
      flex-direction: column;
      gap: 14px;
    }

    .info .label{ color:#9ca3af; font-size: 13px; margin-top: 10px; }
    .info .value{ font-size: 16px; margin-top: 2px; word-break: break-word; }

    .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; border:1px solid #334155; }
    .okb { background:#052e1a; border-color:#14532d; }
    .warn { background:#2a1d05; border-color:#78350f; }
    .bad { background:#2a0a0a; border-color:#7f1d1d; }

    .qrBox{
      width: min(320px, 90vw);
      aspect-ratio: 1/1;
      background:#fff;
      border-radius: 16px;
      padding: 10px;
      box-sizing: border-box;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #qrOut{ width: 100%; height:100%; display:flex; align-items:center; justify-content:center; }
    #qrOut img, #qrOut canvas{ width:100% !important; height:100% !important; display:block; }

    .actions{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      max-width: 720px;
      margin: 10px auto 0;
    }

    @media (min-width: 900px){
      .grid{ grid-template-columns: 1.2fr 0.8fr; align-items: start; }
      .actions{ grid-template-columns: 1fr 1fr; }
      video{ max-height: 420px; }
    }

    /* Overlay de carga encima de la c√°mara */
.camWrap { position: relative; } /* importante */

.scanOverlay{
  position:absolute;
  left: 14px;
  right: 14px;

  /* ajusta si tu card tiene padding distinto */
  top: 54px;          /* cae encima del √°rea del video */
  bottom: 140px;      /* deja libres input/bot√≥n */

  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap: 10px;

  border-radius: 14px;
  background: rgba(0,0,0,.35);
  backdrop-filter: blur(2px);
  border: 1px solid rgba(255,255,255,.06);
  z-index: 5;
}

.spinner{
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,.25);
  border-top-color: rgba(255,255,255,.95);
  animation: spin 0.9s linear infinite;
}

.scanText{
  font-weight: 700;
  font-size: 14px;
  color: #e5e7eb;
}

@keyframes spin{
  to { transform: rotate(360deg); }
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>üì∑ Staff ¬∑ Esc√°ner</h1>
        <div class="muted" id="subtitle">Listo para escanear</div>
      </div>
      <div class="row">
        <button class="btn" id="logoutBtn">Salir</button>
      </div>
    </div>

    <div class="grid">
      <!-- C√°mara + manual -->
      <div class="card camWrap">
        <div class="muted">Escanea el QR del pase (c√°mara trasera si existe).</div>

        <video id="video" playsinline></video>

        <div id="scanOverlay" class="scanOverlay" style="display:none;">
          <div class="spinner"></div>
          <div class="scanText">Leyendo QR‚Ä¶</div>
        </div>


        <div class="row">
          <input id="tokenInput" placeholder="O pega token manualmente" autocomplete="off" autocapitalize="none" />
          <button class="btn" id="btnBuscar">Buscar</button>
        </div>

        <div id="okBox" class="ok"></div>
        <div id="errorBox" class="error"></div>

        <div class="muted">
          Si no detecta QR: en algunos dispositivos el escaneo requiere Chrome/Edge reciente.
        </div>
      </div>

      <!-- Resultado -->
      <div class="card">
        <div class="ticket" id="ticketBox" style="display:none;">
          <div class="ticketGrid">
            <div class="info">
              <div class="label">Estatus</div>
              <div class="value" id="tStatus"></div>

              <div class="label">Nombre</div>
              <div class="value" id="tNombre"></div>

              <div class="label">Asiento</div>
              <div class="value" id="tAsiento"></div>

              <div class="label">Fecha y hora</div>
              <div class="value" id="tFechaHora"></div>
            </div>

            <!--<div>
              <div class="label" style="text-align:center;">QR</div>
              <div class="qrBox"><div id="qrOut"></div></div>
            </div> -->
          </div>
        </div>

        <div class="actions" id="actionsBox" style="display:none;">
          <button class="btn primary" id="btnCheckin">Marcar llegada</button>
          <button class="btn" id="btnLimpiar">Limpiar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR local (solo para mostrar el QR en resultado) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!--<script src="https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js"></script>-->

<script>
  // ============================
  // CONFIG
  // ============================
  const API_URL = "https://script.google.com/macros/s/AKfycbxb7tNEfgSrmGHAYDYR76rJw3eS9XJ2XG2JaDppxiS1ls0j_iQJck5599wGbkBlvxezZg/exec";

  const AUTH_KEY = "staffAuthOk";
  const AUTH_TS_KEY = "staffAuthTs";
  const PIN_KEY = "staffPin";
  const AUTH_TTL_MS = 8 * 60 * 60 * 1000;

  let zxingReader = null;
  let videoStream = null;

  let scanning = false;
  let scannerSessionId = 0;     // ‚úÖ invalida loops viejos
let startInProgress = false;  // ‚úÖ evita doble start

  let scannerRunning = false;

  // Evita doble carga si detecta el QR varias veces
  let isProcessingTicket = false;

  // Ticket actual
  let currentToken = "";
  let lastScannedText = "";

  const $ = (id) => document.getElementById(id);

  function setSubtitle(txt){ $("subtitle").textContent = txt; }

  function showError(msg){
    const b = $("errorBox");
    b.style.display = "block";
    b.textContent = msg;
    $("okBox").style.display = "none";
  }

  function showOk(msg){
    const b = $("okBox");
    b.style.display = "block";
    b.textContent = msg;
    $("errorBox").style.display = "none";
  }

  function clearMsgs(){
    $("errorBox").style.display = "none";
    $("errorBox").textContent = "";
    $("okBox").style.display = "none";
    $("okBox").textContent = "";
  }

  // ============================
  // LOADER (Overlay + Spinner)
  // ============================
  function setLoading_(on, msg){
    const ov = $("scanOverlay");
    if (!ov) return;
    ov.style.display = on ? "flex" : "none";
    const t = ov.querySelector(".scanText");
    if (t) t.textContent = msg || (on ? "Leyendo QR‚Ä¶" : "");
  }

  // ============================
  // AUTH
  // ============================
  function isAuthValid_(){
    const ok = sessionStorage.getItem(AUTH_KEY) === "1";
    const ts = Number(sessionStorage.getItem(AUTH_TS_KEY) || "0");
    return ok && ts && (Date.now() - ts) < AUTH_TTL_MS;
  }

  function touchAuth_(){
    if (sessionStorage.getItem(AUTH_KEY) === "1") {
      sessionStorage.setItem(AUTH_TS_KEY, String(Date.now()));
    }
  }

  function clearAuth_(){
    sessionStorage.removeItem(AUTH_KEY);
    sessionStorage.removeItem(AUTH_TS_KEY);
    sessionStorage.removeItem(PIN_KEY);
  }

  function enforceAuthOrRedirect_(){
    if (!isAuthValid_()){
      clearAuth_();
      location.replace("./index.html");
      return false;
    }
    touchAuth_();
    return true;
  }

  function logout_(){
    stopScanner_();
    clearAuth_();
    location.replace("./index.html");
  }

  // ============================
  // API
  // ============================
  async function apiGetTicket(token){
    const url = `${API_URL}?action=ticket&token=${encodeURIComponent(token)}`;
    const res = await fetch(url, { method: "GET" });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error("Respuesta no JSON: " + text); }
    return data;
  }

  async function apiCheckin(token, pin){
    const res = await fetch(API_URL, {
      method: "POST",
      body: new URLSearchParams({ action: "checkin", token, pin })
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error("Respuesta no JSON: " + text); }
    return data;
  }

  // ============================
  // QR -> token
  // ============================
  function extractTokenFromQrText(txt){
    const s = String(txt || "").trim();
    if (!s) return "";
    try {
      const u = new URL(s);
      const t = (u.searchParams.get("token") || "").trim();
      if (t) return t;
    } catch(_) {}
    return s;
  }

  // ============================
  // UI Ticket
  // ============================
  function setStatusBadge(status){
    const s = String(status || "").toUpperCase();
    let cls = "badge";
    let label = s || "DESCONOCIDO";

    if (s === "ISSUED") { cls += " okb"; label = "V√ÅLIDO"; }
    else if (s === "USED") { cls += " warn"; label = "YA USADO"; }
    else if (s === "CANCELED" || s === "EXPIRED") { cls += " bad"; label = s; }
    else { cls += " bad"; }

    $("tStatus").innerHTML = `<span class="${cls}">${label}</span>`;
  }

  function updateCheckinButton_(status){
    const s = String(status || "").toUpperCase();
    const btn = $("btnCheckin");

    const isUsed = (s === "USED");
    const isInvalid = (s === "CANCELED" || s === "EXPIRED");

    if (isUsed || isInvalid) {
      btn.disabled = true;
      btn.textContent = isUsed ? "Ya utilizado" : "No v√°lido";
      btn.classList.add("danger");
    } else {
      btn.disabled = false;
      btn.textContent = "Marcar llegada";
      btn.classList.remove("danger");
    }
  }

  function showTicketUI_(ticket, scannedText){
    $("ticketBox").style.display = "block";
    $("actionsBox").style.display = "grid";

    const status = (ticket.estatus || ticket.status || "").toUpperCase();

    setStatusBadge(status);
    $("tNombre").textContent = ticket.nombre || "-";
    $("tAsiento").textContent = ticket.asiento || "-";
    $("tFechaHora").textContent = ticket.fechaHora || "-";

    updateCheckinButton_(status);
  }

  function clearTicketUI_(){
    $("ticketBox").style.display = "none";
    $("actionsBox").style.display = "none";
    $("qrOut").innerHTML = "";
    $("tStatus").innerHTML = "";
    $("tNombre").textContent = "";
    $("tAsiento").textContent = "";
    $("tFechaHora").textContent = "";
  }

  // ============================
  // Flujo
  // ============================
  async function loadAndShowTicket_(token, scannedText){
    if (!enforceAuthOrRedirect_()) return;
    if (isProcessingTicket) return;

    isProcessingTicket = true;
    clearMsgs();
    setSubtitle("Buscando‚Ä¶");
    setLoading_(true, "Validando pase‚Ä¶");

    try{
      const data = await apiGetTicket(token);

      if (!data.ok){
        clearTicketUI_();
        setSubtitle("No encontrado");
        showError("Pase no encontrado o token inv√°lido.");
        return;
      }

      touchAuth_();

      currentToken = token;
      lastScannedText = scannedText || "";

      setSubtitle("Pase cargado");
      showOk("‚úÖ Pase cargado. C√°mara en pausa (presiona Limpiar para escanear otro).");
      showTicketUI_(data.ticket, scannedText || token);

      pauseScanner_();
    } catch(e){
      console.error(e);
      setSubtitle("Error");
      showError("Error al consultar el pase: " + (e?.message || e));
    } finally {
      setLoading_(false);
      isProcessingTicket = false;
    }
  }

  async function doManualSearch_(){
    if (!enforceAuthOrRedirect_()) return;

    const token = ($("tokenInput").value || "").trim();
    if (!token) { showError("Pega un token para buscar."); return; }

    await loadAndShowTicket_(token, token);
  }

  async function ensurePin_(){
    let pin = sessionStorage.getItem(PIN_KEY);
    if (pin) return pin;

    pin = prompt("Ingresa el PIN del staff para marcar llegada:");
    if (!pin) throw new Error("PIN requerido.");
    pin = String(pin).trim();
    sessionStorage.setItem(PIN_KEY, pin);
    return pin;
  }

  async function doCheckin_(){
    if (!enforceAuthOrRedirect_()) return;
    if (!currentToken) { showError("No hay ticket cargado."); return; }

    const btn = $("btnCheckin");
    // Si ya est√° deshabilitado (USED), no hacer nada
    if (btn.disabled) return;

    btn.disabled = true;
    btn.textContent = "Marcando‚Ä¶";
    setLoading_(true, "Marcando llegada‚Ä¶");

    try{
      clearMsgs();
      const pin = await ensurePin_();
      const r = await apiCheckin(currentToken, pin);

      if (!r.ok){
        if (r.error === "INVALID_PIN") sessionStorage.removeItem(PIN_KEY);
        showError("No se pudo marcar: " + (r.error || "ERROR"));
        return;
      }

      touchAuth_();
      showOk(r.alreadyUsed ? "‚ö†Ô∏è Este pase YA estaba usado." : "‚úÖ Llegada marcada.");

      // refrescar ticket (aqu√≠ se aplicar√° el bloqueo si queda USED)
      await loadAndShowTicket_(currentToken, lastScannedText || currentToken);
    } catch(e){
      console.error(e);
      showError("Error en check-in: " + (e?.message || e));
    } finally {
      setLoading_(false);
      // NO forzamos a habilitar el bot√≥n aqu√≠:
      // showTicketUI_ decide si se bloquea seg√∫n status.
      if (!$("btnCheckin").disabled) {
        $("btnCheckin").textContent = "Marcar llegada";
      }
    }
  }

  function doClear_(){
  currentToken = "";
  lastScannedText = "";
  isProcessingTicket = false;

  $("tokenInput").value = "";
  clearMsgs();
  clearTicketUI_();
  setLoading_(false);

  restartScanner_(); // ‚úÖ en vez de resumeScanner_
}


  // ============================
  // C√°mara + scanner
  // ============================
  function sleep_(ms){ return new Promise(r => setTimeout(r, ms)); }

  async function startCamera_(){
    const video = $("video");
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    video.srcObject = videoStream;
    await video.play();
  }

  function loadZxingIfNeeded_(){
    return new Promise((resolve, reject) => {
      if (window.ZXingBrowser?.BrowserQRCodeReader) return resolve();

      const existing = document.querySelector('script[data-zxing="1"]');
      if (existing) {
        existing.addEventListener("load", resolve, { once:true });
        existing.addEventListener("error", () => reject(new Error("ZXing no carg√≥")), { once:true });
        return;
      }

      const s = document.createElement("script");
      s.src = "https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js";
      s.defer = true;
      s.setAttribute("data-zxing","1");
      s.onload = resolve;
      s.onerror = () => reject(new Error("No se pudo cargar ZXing."));
      document.head.appendChild(s);
    });
  }

  async function scanLoop_(){
  const video = $("video");
  const mySession = scannerSessionId; // ‚úÖ ‚Äúeste‚Äù arranque

  // 1) BarcodeDetector
  if ("BarcodeDetector" in window) {
    try {
      const formats = await BarcodeDetector.getSupportedFormats();
      if (Array.isArray(formats) && formats.includes("qr_code")) {
        const detector = new BarcodeDetector({ formats: ["qr_code"] });
        scanning = true;

        while (scanning && mySession === scannerSessionId) {
          if (currentToken || isProcessingTicket) { await sleep_(150); continue; }

          try {
            const barcodes = await detector.detect(video);
            if (mySession !== scannerSessionId) break;

            if (barcodes?.length) {
              const raw = barcodes[0].rawValue || "";
              const token = extractTokenFromQrText(raw);
              if (token) {
                setLoading_(true, "QR detectado‚Ä¶");
                await loadAndShowTicket_(token, raw);
                await sleep_(400);
              }
            }
          } catch(_) {}

          await sleep_(120);
        }
        return;
      }
    } catch(_) {}
  }

  // 2) ZXing fallback
  await loadZxingIfNeeded_();
  if (!(window.ZXingBrowser?.BrowserQRCodeReader)) {
    showError("No se pudo cargar el lector QR (ZXing). Usa b√∫squeda manual.");
    return;
  }

  zxingReader = new ZXingBrowser.BrowserQRCodeReader();
  scanning = true;

  try {
    await zxingReader.decodeFromVideoElement(video, async (result) => {
      if (!scanning) return;
      if (mySession !== scannerSessionId) return;
      if (currentToken || isProcessingTicket) return;

      if (result) {
        const raw = result.getText ? result.getText() : "";
        const token = extractTokenFromQrText(raw);
        if (token) {
          setLoading_(true, "QR detectado‚Ä¶");
          await loadAndShowTicket_(token, raw);
          await sleep_(400);
        }
      }
    });
  } catch(e){
    if (mySession === scannerSessionId) {
      showError("No se pudo iniciar el lector QR. Revisa permisos de c√°mara.");
    }
  }
}

  function stopScanner_(){
  // ‚úÖ invalida cualquier loop viejo
  scannerSessionId++;
  scanning = false;
  scannerRunning = false;

  // ZXing
  if (zxingReader) {
    try { zxingReader.reset(); } catch(_) {}
    zxingReader = null;
  }

  // Video element
  const video = $("video");
  if (video) {
    try { video.pause(); } catch(_) {}
    try { video.srcObject = null; } catch(_) {}
  }

  // MediaStream
  if (videoStream){
    try {
      for (const t of videoStream.getTracks()) {
        try { t.stop(); } catch(_) {}
      }
    } finally {
      videoStream = null;
    }
  }
}


  function pauseScanner_(){
    stopScanner_();
    setSubtitle("Pase cargado (c√°mara en pausa)");
  }

  function startScanner_(){
  if (!enforceAuthOrRedirect_()) return;
  if (scannerRunning || startInProgress) return;

  startInProgress = true;
  scannerRunning = true;

  clearMsgs();
  setLoading_(false);
  setSubtitle("Escaneando‚Ä¶");

  (async () => {
    try {
      await startCamera_();
      await scanLoop_();
    } catch (e) {
      console.error(e);
      showError("No se pudo iniciar c√°mara/lector. Revisa permisos.");
    } finally {
      startInProgress = false;
      scannerRunning = false;
    }
  })();
}

function restartScanner_(){
  // ‚úÖ stop + peque√±o delay para que el navegador libere la c√°mara
  stopScanner_();
  setTimeout(() => {
    // ‚úÖ importante: currentToken debe estar vac√≠o para escanear
    startScanner_();
  }, 450);
}


  // ============================
  // INIT
  // ============================
  document.addEventListener("DOMContentLoaded", () => {
    if (!enforceAuthOrRedirect_()) return;

    $("logoutBtn").addEventListener("click", logout_);
    $("btnBuscar").addEventListener("click", doManualSearch_);
    $("tokenInput").addEventListener("keydown", (e)=> { if (e.key === "Enter") doManualSearch_(); });

    $("btnCheckin").addEventListener("click", doCheckin_);
    $("btnLimpiar").addEventListener("click", doClear_);

    startScanner_();
    window.addEventListener("beforeunload", stopScanner_);
  });
</script>









</body>
</html>
